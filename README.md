## TradingView 批量回测浏览器插件（初版骨架）

这个项目是一个 Chrome 扩展，用于在 TradingView 上从「筛选器」页面批量跑指定策略的回测，并将结果导出为 CSV。

> 注意：TradingView 的前端 DOM 结构会不定期变化，因此本项目中的很多选择器目前只是**骨架示例**，需要你在实际使用时打开浏览器开发者工具，按当前页面结构适配和微调。

### 安装与加载扩展

1. 在本仓库中执行 `git clone`（你已经完成）。
2. 打开 Chrome 或 Edge，地址栏输入：`chrome://extensions/`。
3. 右上角打开「开发者模式」。
4. 点击「加载已解压的扩展程序」，选择本项目所在文件夹 `tradingview_plugin`。

### 基本使用流程

1. 登录 TradingView，在浏览器中打开任一 TradingView 页面（建议直接打开你经常使用的图表页）。
2. 点击浏览器右上角扩展图标，找到「TradingView 批量回测助手」，打开弹窗：
   - 在「策略名称」中填入你在 TradingView 右侧列表中看到的策略名称（完全匹配）。
   - 选择时间周期（如 日线、4 小时等）。
   - 选择回测开始/结束日期（可留空，则使用默认历史）。
   - 设置最大标的数量与每个标的之间的延时（越长越稳，但整体耗时更长）。
   - 点击「保存设置」。
3. 在 TradingView 中打开你要批量筛选的「筛选器」页面（股票/期货/加密货币等）。
4. 再次打开扩展弹窗，点击「在当前 TradingView 标签页开始批量回测」。
5. 扩展会尝试在当前页面依次切换标的、应用策略与时间周期、设置回测区间，然后读取策略测试器中的关键指标，并在最后下载一个 CSV 文件。

### 你需要根据自己界面微调的地方

- `content.js` 中的 DOM 选择器：
  - `detectScreenerRows`：用于在筛选器页面找到表格与行。
  - `extractSymbolFromRow`：用于从表格行中提取代码。
  - `applyStrategyAndTimeframeInChart`：根据图表页上「时间周期按钮」和「指标与策略按钮」的实际结构调整选择器。
  - `configureBacktestRange`：根据策略测试器中「回测时间区间」控件的实际结构调整选择器。
  - `readBacktestResultForCurrentSymbol`：根据当前策略测试器结果表格的结构，精确定义净利润、胜率、最大回撤和交易次数的读取方式。

建议步骤：

1. 在 TradingView 页面上按 `F12` 打开开发者工具，切到「Elements」。
2. 使用右上角的小箭头图标，依次点选：
   - 筛选器表格行（用于确认 `detectScreenerRows` 的选择器）。
   - 图表页面顶部的「标的代码输入框」。
   - 时间周期选择按钮和对应的下拉选项。
   - 「指标与策略」或「策略测试器」按钮。
   - 策略列表中的你的策略名称所在元素。
   - 回测日期区间输入框与应用按钮。
   - 策略测试结果表中的净利润、胜率、最大回撤、交易次数等字段所在单元格。
3. 根据真实的 class / data-* 属性，把 `content.js` 中对应的 `querySelector`/`querySelectorAll` 修改成合适的 CSS 选择器。

### 关键文件说明

- `manifest.json`：Chrome 扩展配置，声明了权限、后台脚本、弹窗和内容脚本。
- `background.js`：
  - 负责存取批量回测的配置（策略名、周期、日期区间、延时等）。
  - 负责处理 CSV 内容，并触发浏览器下载。
- `popup.html` + `popup.js`：
  - 扩展图标点击后的弹窗 UI。
  - 配置策略与回测参数，点击后在当前 TradingView 标签页触发批量回测。
- `content.js`：
  - 运行在 TradingView 页面内。
  - 扫描筛选器表格、依次处理标的。
  - 切换图表标的、应用策略和时间周期。
  - 读取策略测试器返回的各项指标，并最终发给 `background.js` 导出 CSV。

### 后续可以增强的方向

- 把 DOM 选择器抽成一个单独配置文件，以适配不同语言版本和 UI 主题。
+- 捕获异常并在页面上展示当前进度（例如在页面右下角插入一个浮动小面板显示「X/Y 已完成」）。
  - 支持多策略一次性批量回测，CSV 中增加策略维度。
  - 增加对不同品种（股票、期货、币种）的特定字段支持。


